# 主程序流程优化说明

## 📋 更新内容

### 1. ✅ 自动配置检测
程序启动时会自动检查 `user_data/settings.json` 中的必需配置项：
- `yolo_fps` - YOLO检测帧率
- `best_ocr` - 最佳OCR引擎
- `preferred_provider` - 首选ONNX提供商
- `best_ocr_engine` - 最佳OCR引擎名称

**行为逻辑：**
- ✅ 如果配置完整 → 显示开始窗口，可以直接启动助手
- ❌ 如果配置缺失 → 自动延迟1秒后启动诊断流程

### 2. ✅ 开始窗口双按钮设计

**新增按钮布局：**
```
┌─────────────────────────────┐
│  🔍 手动自检  │  🚀 启动助手  │
└─────────────────────────────┘
```

**功能说明：**
- **🔍 手动自检**：无论配置是否完整，都可以手动启动诊断
- **🚀 启动助手**：
  - 配置完整 → 直接进入主界面（sidebar）
  - 配置不完整 → 提示先运行自检

### 3. ✅ 诊断完成后进入主界面

**"进入主界面"按钮行为：**
- 点击后发射 `enter_main_requested` 信号
- 主程序接收信号，显示 sidebar
- 隐藏开始窗口和诊断窗口

## 🔄 完整流程图

### 首次运行流程
```
启动程序
    ↓
检测配置文件
    ↓
[配置缺失]
    ↓
显示开始窗口
    ↓
延迟1秒自动启动诊断
    ↓
诊断窗口运行检测
    ↓
检测完成，保存配置
    ↓
点击"进入主界面"
    ↓
显示 Sidebar（主界面）
```

### 正常运行流程
```
启动程序
    ↓
检测配置文件
    ↓
[配置完整]
    ↓
显示开始窗口
    ↓
用户选择：
    ├─ 点击"启动助手" → 直接显示 Sidebar
    └─ 点击"手动自检" → 显示诊断窗口
                          ↓
                      检测完成
                          ↓
                  点击"进入主界面"
                          ↓
                    显示 Sidebar
```

## 🎯 关键代码改动

### main.py
```python
# 新增配置检测方法
def _need_diagnostic(self):
    """检查是否需要运行诊断"""
    # 检查4个必需配置项
    
# 新增启动逻辑
def run(self):
    if self._need_diagnostic():
        # 自动诊断
    else:
        # 直接显示开始窗口
        
# 新增主界面显示方法
def show_main_window(self):
    """显示主界面（侧边栏）"""
    self.sidebar_win.show()
```

### start_window.py
```python
# 新增信号
diagnostic_requested = Signal()  # 手动自检

# 新增按钮
btn_diagnostic = StyledButton("🔍 手动自检")
btn_enter = StyledButton("🚀 启动助手")
```

### diagnostics_window.py
```python
# 新增信号
enter_main_requested = Signal()  # 请求进入主界面

# 修改按钮行为
def _on_enter_main(self):
    self.enter_main_requested.emit()
    self.hide()
```

## 📦 配置文件格式

`user_data/settings.json` 必需包含：
```json
{
    "yolo_fps": 4,
    "best_ocr": "Windows_Native",
    "preferred_provider": "CPUExecutionProvider",
    "best_ocr_engine": "Windows_Native"
}
```

## 🧪 测试场景

### 场景1：首次运行（无配置）
1. 删除或重命名 `user_data/settings.json`
2. 运行 `python main.py`
3. ✅ 应该显示开始窗口
4. ✅ 1秒后自动弹出诊断窗口并开始检测
5. ✅ 检测完成后点击"进入主界面"
6. ✅ 显示 sidebar

### 场景2：配置完整
1. 确保 `user_data/settings.json` 包含所有必需字段
2. 运行 `python main.py`
3. ✅ 应该显示开始窗口
4. ✅ 点击"启动助手"
5. ✅ 直接显示 sidebar（不经过诊断）

### 场景3：手动自检
1. 运行 `python main.py`
2. ✅ 显示开始窗口
3. ✅ 点击"手动自检"
4. ✅ 显示诊断窗口并开始检测
5. ✅ 检测完成后点击"进入主界面"
6. ✅ 显示 sidebar

### 场景4：配置不完整
1. 修改 `user_data/settings.json`，删除某个必需字段
2. 运行 `python main.py`
3. ✅ 显示开始窗口
4. ✅ 自动启动诊断
5. 或者点击"启动助手"
6. ✅ 提示配置不完整，跳转到诊断

## 🎨 视觉更新

开始窗口底部按钮现在是并排的：
```
┌──────────────────────────────────────┐
│                                      │
│         集市小抄                      │
│      BAZAAR ASSISTANT                │
│                                      │
│  ┌────────────────────────────────┐ │
│  │  🎉 v2.1.0 - 核心引擎重构版    │ │
│  │  ─────────────────────────────  │ │
│  │  🧠 脑子是用来构筑的，数据...   │ │
│  │  ⚡ 智能识别 · 实时推荐 ...    │ │
│  │  🎮 助你在集市中运筹帷幄       │ │
│  │  ⚠️ 本工具由B站@这是李...     │ │
│  └────────────────────────────────┘ │
│                                      │
│    ┌─────────────┐ ┌─────────────┐  │
│    │ 🔍 手动自检  │ │ 🚀 启动助手  │  │
│    └─────────────┘ └─────────────┘  │
└──────────────────────────────────────┘
```

## ✅ 完成清单

- [x] 添加配置检测逻辑
- [x] 开始窗口添加手动自检按钮
- [x] 首次运行自动诊断
- [x] 诊断完成后进入主界面
- [x] 配置完整时直接进入
- [x] 信号连接正确
- [x] 无编译错误

## 🚀 下一步

现在你可以：
1. 运行 `python main.py` 测试完整流程
2. 验证配置检测是否正常工作
3. 测试所有按钮是否按预期工作
4. 开始实现 sidebar 的具体功能
