# 灵动岛集成说明

## 📋 更新内容

### 1. ✅ 灵动岛窗口创建 (`gui/windows/island_window.py`)

**核心功能：**
- **常态信息胶囊**：显示当前天数和阶段状态
- **可拖动**：支持拖动到任意位置
- **磁吸效果**：靠近屏幕顶部中央时自动吸附
- **双击展开**：双击灵动岛展开侧边栏

**状态系统：**
```python
STATE_NORMAL    # 常态：信息胶囊（暗金边框）
STATE_SCANNING  # 识别态：流光扫描（渐变边框）
STATE_CONFIRM   # 确权态：确认反馈（亮金边框）
STATE_ALERT     # 警报态：机械展开（预留）
```

**视觉特性：**
- 黑色半透明背景 (20, 20, 25, 220)
- 金色发光文字 (#ffcc00)
- 圆角 18px
- 默认尺寸：200x36px

---

### 2. ✅ 侧边栏收起功能改造

**改动说明：**
- ❌ **删除关闭按钮**（原来的 "✕" 按钮）
- ✅ **保留收起按钮**（"◀" 按钮）
- ✅ **新增信号**：`collapse_to_island` - 请求收起到灵动岛

**按钮行为：**
- 点击 "◀" 收起按钮 → 触发收起到灵动岛动画
- 工具提示：`"收起到灵动岛"`

---

### 3. ✅ 主程序动画联动 (`main.py`)

**新增窗口：**
```python
self.island_win = IslandWindow()  # 灵动岛实例
```

**信号绑定：**
```python
# 侧边栏 → 灵动岛
self.sidebar_win.collapse_to_island.connect(self.collapse_sidebar_to_island)

# 灵动岛 → 侧边栏
self.island_win.expand_requested.connect(self.expand_island_to_sidebar)
```

**动画效果：**

#### 收起动画（侧边栏 → 灵动岛）
```
1. 侧边栏从右侧原位置开始
2. 同时缩小到 50% 大小
3. 移动到灵动岛中心位置
4. 400ms 平滑过渡（InOutCubic）
5. 完成后隐藏侧边栏，显示灵动岛
```

#### 展开动画（灵动岛 → 侧边栏）
```
1. 双击灵动岛
2. 侧边栏从灵动岛位置以 50% 大小显示
3. 同时放大到 100% 大小
4. 移动到屏幕右侧正常位置
5. 400ms 平滑过渡（OutCubic）
6. 隐藏灵动岛
```

---

## 🎨 用户体验流程

### 场景1：首次进入主界面
```
开始窗口 → 诊断窗口 → 侧边栏（右侧）
                        ↓
                    灵动岛隐藏
```

### 场景2：收起到灵动岛
```
侧边栏右侧显示
    ↓
点击 "◀" 收起按钮
    ↓
[动画] 侧边栏缩小并移向屏幕顶部
    ↓
灵动岛胶囊出现在顶部中央
    ↓
侧边栏隐藏
```

### 场景3：从灵动岛展开
```
灵动岛显示在顶部
    ↓
双击灵动岛
    ↓
[动画] 从灵动岛位置展开侧边栏
    ↓
侧边栏完整显示在右侧
    ↓
灵动岛隐藏
```

---

## 🔧 技术实现细节

### 窗口属性
```python
# 灵动岛
Qt.FramelessWindowHint  # 无边框
Qt.WindowStaysOnTopHint # 置顶
Qt.Tool                 # 不在任务栏显示
Qt.WA_TranslucentBackground  # 透明背景
```

### 动画参数
```python
# 收起动画
duration: 400ms
easing: InOutCubic (平滑进出)
target_size: 50% 原始大小

# 展开动画
duration: 400ms
easing: OutCubic (快速开始，平滑结束)
target_size: 100% 原始大小
```

### 磁吸逻辑
```python
# 当灵动岛被拖动到：
if y < 100 and |x - screen_center| < 200:
    # 自动吸附到顶部中央
    smooth_move_to(screen_center, y=10)
```

---

## 📦 文件清单

### 新增文件
- ✅ `gui/windows/island_window.py` - 灵动岛窗口

### 修改文件
- ✅ `gui/windows/sidebar_window.py` - 删除关闭按钮，添加收起信号
- ✅ `main.py` - 集成灵动岛，实现动画联动

---

## 🎯 待实现功能（后续）

### 识别态动画
```python
# 当 YOLO 开始推理时
island_win.set_state(STATE_SCANNING)
# 触发：
# - 呼吸灯效果（边框明暗交替）
# - 扫描波（金色光束从左向右）
# - 文字："Analyzing Field..."
```

### 确权态反馈
```python
# 当 FeatureMatcher 确认卡牌时
island_win.set_state(STATE_CONFIRM)
# 触发：
# - 边框瞬间变亮
# - 绿色 ✅ 图标闪烁 0.5s
# - 文字："+ [獠牙] ID Confirmed"
```

### 警报态展开
```python
# 当识别到关键卡牌时
island_win.set_state(STATE_ALERT)
# 触发：
# - 机械式展开（向下裂开）
# - 显示卡牌立绘
# - 红色/紫色脉冲边框
# - 文字："🔥 CORE ITEM FOUND: MEDUSA!"
```

### 右键菜单
```python
# 右键灵动岛弹出菜单：
- 快速自检
- 显示/隐藏侧边栏
- 强制重启 YOLO 推理
```

---

## 🧪 测试步骤

1. **运行程序**
   ```bash
   python main.py
   ```

2. **进入主界面**
   - 点击"启动助手"或完成诊断
   - 侧边栏应该显示在屏幕右侧

3. **测试收起动画**
   - 点击侧边栏顶部的 "◀" 按钮
   - 观察侧边栏是否平滑缩小并移向顶部
   - 灵动岛胶囊是否出现在顶部中央

4. **测试展开动画**
   - 双击顶部的灵动岛
   - 观察侧边栏是否从灵动岛位置展开
   - 是否平滑移动到右侧正常位置

5. **测试磁吸效果**
   - 拖动灵动岛靠近屏幕顶部中央
   - 释放后是否自动吸附到中心位置

---

## 🎨 视觉效果预览

### 灵动岛常态
```
┌─────────────────────────────┐
│  Day 13 • Phase: Shop       │  ← 200x36px
└─────────────────────────────┘
    暗金边框 1px，黑色半透明
```

### 收起动画中间态
```
      [侧边栏]         [侧边栏缩小]
         │                │
         │                │
         ↓                ↓
    屏幕右侧  →→→  逐渐缩小移动  →→→  [灵动岛]
                                       顶部中央
```

### 展开动画中间态
```
   [灵动岛]         [侧边栏展开]      [侧边栏]
   顶部中央              │               │
      │                  │               │
      ↓                  ↓               ↓
  双击触发  →→→  从小到大展开  →→→  完整显示
                                      屏幕右侧
```

---

## ✅ 完成状态

- [x] 灵动岛窗口创建
- [x] 常态信息显示（Day + Phase）
- [x] 拖动功能
- [x] 磁吸效果
- [x] 双击展开
- [x] 侧边栏删除关闭按钮
- [x] 收起信号连接
- [x] 收起动画实现
- [x] 展开动画实现
- [x] 无编译错误

## 🚀 下一步

1. 实现识别态的流光边框动画
2. 添加确权态的反馈效果
3. 连接实际 YOLO 识别状态
4. 实现右键菜单
5. 添加鼠标穿透控制
